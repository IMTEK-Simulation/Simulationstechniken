<!DOCTYPE html> <html lang="en-US"> <head> <meta charset="UTF-8"> <meta http-equiv="X-UA-Compatible" content="IE=Edge"> <title>Milestone 03 - Simulationstechniken</title> <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon"> <link rel="stylesheet" href="/assets/css/just-the-docs-default.css"> <script type="text/javascript" src="/assets/js/vendor/lunr.min.js"></script> <script type="text/javascript" src="/assets/js/just-the-docs.js"></script> <meta name="viewport" content="width=device-width, initial-scale=1"> <!-- Begin Jekyll SEO tag v2.7.1 --> <title>Milestone 03 | Simulationstechniken</title> <meta name="generator" content="Jekyll v3.9.0" /> <meta property="og:title" content="Milestone 03" /> <meta name="author" content="Lars Pastewka" /> <meta property="og:locale" content="en_US" /> <meta name="description" content="Simulationstechniken" /> <meta property="og:description" content="Simulationstechniken" /> <link rel="canonical" href="http://localhost:4000/_homework/uebungsblatt03.html" /> <meta property="og:url" content="http://localhost:4000/_homework/uebungsblatt03.html" /> <meta property="og:site_name" content="Simulationstechniken" /> <meta name="twitter:card" content="summary" /> <meta property="twitter:title" content="Milestone 03" /> <script type="application/ld+json"> {"author":{"@type":"Person","name":"Lars Pastewka"},"@type":"WebPage","description":"Simulationstechniken","url":"http://localhost:4000/_homework/uebungsblatt03.html","headline":"Milestone 03","@context":"https://schema.org"}</script> <!-- End Jekyll SEO tag --> </head> <body> <svg xmlns="http://www.w3.org/2000/svg" style="display: none;"> <symbol id="svg-link" viewBox="0 0 24 24"> <title>Link</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-link"> <path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path> </svg> </symbol> <symbol id="svg-search" viewBox="0 0 24 24"> <title>Search</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-search"> <circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line> </svg> </symbol> <symbol id="svg-menu" viewBox="0 0 24 24"> <title>Menu</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-menu"> <line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line> </svg> </symbol> <symbol id="svg-arrow-right" viewBox="0 0 24 24"> <title>Expand</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-chevron-right"> <polyline points="9 18 15 12 9 6"></polyline> </svg> </symbol> <symbol id="svg-doc" viewBox="0 0 24 24"> <title>Document</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-file"> <path d="M13 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V9z"></path><polyline points="13 2 13 9 20 9"></polyline> </svg> </symbol> </svg> <div class="side-bar"> <div class="site-header"> <a href="http://localhost:4000/" class="site-title lh-tight"> Simulationstechniken </a> <a href="#" id="menu-button" class="site-button"> <svg viewBox="0 0 24 24" class="icon"><use xlink:href="#svg-menu"></use></svg> </a> </div> <nav role="navigation" aria-label="Main" id="site-nav" class="site-nav"> <ul class="nav-list"><li class="nav-list-item"><a href="#" class="nav-list-expander"><svg viewBox="0 0 24 24"><use xlink:href="#svg-arrow-right"></use></svg></a><a href="http://localhost:4000/_lecture/" class="nav-list-link">Vorlesung</a><ul class="nav-list "></ul></li><li class="nav-list-item"><a href="#" class="nav-list-expander"><svg viewBox="0 0 24 24"><use xlink:href="#svg-arrow-right"></use></svg></a><a href="http://localhost:4000/_homework/" class="nav-list-link">Übungsaufgaben</a><ul class="nav-list "></ul></li><li class="nav-list-item"><a href="#" class="nav-list-expander"><svg viewBox="0 0 24 24"><use xlink:href="#svg-arrow-right"></use></svg></a><a href="http://localhost:4000/_notes/" class="nav-list-link">Notizen</a><ul class="nav-list "></ul></li><li class="nav-list-item"><a href="http://localhost:4000/impressum.html" class="nav-list-link">Impressum</a></li></ul> </nav> <footer class="site-footer"> This site uses <a href="https://github.com/pmarsceill/just-the-docs">Just the Docs</a>, a documentation theme for Jekyll. </footer> </div> <div class="main" id="top"> <div id="main-header" class="main-header"> <div class="search"> <div class="search-input-wrap"> <input type="text" id="search-input" class="search-input" tabindex="0" placeholder="Search Simulationstechniken" aria-label="Search Simulationstechniken" autocomplete="off"> <label for="search-input" class="search-label"><svg viewBox="0 0 24 24" class="search-icon"><use xlink:href="#svg-search"></use></svg></label> </div> <div id="search-results" class="search-results"></div> </div> <!-- Add a favicon --> <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico"> <link rel="stylesheet" href="/_includes/md.css"> <!-- Enable Katex for math rendering https://stackoverflow.com/a/57370526 --> <!-- <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.10.2/dist/katex.min.css" integrity="sha384-yFRtMMDnQtDRO8rLpMIKrtPCD5jdktao2TV19YiZYWMDkUR5GQZR/NOVTdquEx1j" crossorigin="anonymous"> <link rel="stylesheet" href="/_includes/md.css"> <script defer src="https://cdn.jsdelivr.net/npm/katex@0.10.2/dist/katex.min.js" integrity="sha384-9Nhn55MVVN0/4OFx7EE5kpFBPsEMZxKTCnA+4fqDmg12eCTqGi6+BB2LjY8brQxJ" crossorigin="anonymous"></script> <script defer src="https://cdn.jsdelivr.net/npm/katex@0.10.2/dist/contrib/auto-render.min.js" integrity="sha384-kWPLUVMOks5AQFrykwIup5lo0m3iMkkHrD0uJ4H5cjeGihAutqP0yW0J6dpFiVkI" crossorigin="anonymous" onload="renderMathInElement(document.body);"></script> --> <script type="text/javascript" id="MathJax-script" async="async" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js"></script> <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script> <script> MathJax = { tex: { tags: 'ams' } }; $(document).ready(function(){ key = 'href'; $('[href^="https://uni-freiburg.cloud.panopto.eu"]').replaceWith(function() { return '<div class="video-container43"><iframe src='+$(this).attr(key)+' frameborder="0" allowfullscreen></iframe></div>'; }); $('[href^="https://www.youtube.com"]').replaceWith(function() { return '<div class="video-container169"><iframe src='+$(this).attr(key)+' frameborder="0" allowfullscreen></iframe></div>'; }); }); </script> <style type="text/css"> .video-container169 { position: relative; padding-bottom: 56.25%; /* 16:9 */ height: 0; } .video-container169 iframe { position: absolute; top: 0; left: 0; width: 100%; height: 100%; } .video-container43 { position: relative; padding-bottom: 75%; /* 4:3; */ height: 0; } .video-container43 iframe { position: absolute; top: 0; left: 0; width: 100%; height: 100%; } </style> </div> <div id="main-content-wrap" class="main-content-wrap"> <nav aria-label="Breadcrumb" class="breadcrumb-nav"> <ol class="breadcrumb-nav-list"> <li class="breadcrumb-nav-list-item"><a href="">Project</a></li> <li class="breadcrumb-nav-list-item"><span>Milestone 03</span></li> </ol> </nav> <div id="main-content" class="main-content" role="main"> <h1 id="milestone-3--velocity-verlet-integration-for-multiple-atoms"> <a href="#milestone-3--velocity-verlet-integration-for-multiple-atoms" class="anchor-heading" aria-labelledby="milestone-3--velocity-verlet-integration-for-multiple-atoms"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Milestone 3 <br /> Velocity-Verlet integration for multiple atoms </h1> <h2 id="learning-goals"> <a href="#learning-goals" class="anchor-heading" aria-labelledby="learning-goals"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Learning goals </h2> <p>The student will…</p> <ul> <li>…learn how to work with <a href="https://eigen.tuxfamily.org/dox/group__TutorialArrayClass.html">Eigen arrays</a>.</li> </ul> <h2 id="introduction"> <a href="#introduction" class="anchor-heading" aria-labelledby="introduction"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Introduction </h2> <p>The implementation of the integration algorithm from Milestone 2 only works for a single atom. You will now extend the function <code class="language-plaintext highlighter-rouge">verlet_step1</code> and <code class="language-plaintext highlighter-rouge">verlet_step2</code> to work with multiple atoms. For this we will have to introduce data structure that can store the positions and velocities of multiple atoms. We will use <a href="https://eigen.tuxfamily.org/dox/group__TutorialArrayClass.html">Eigen arrays</a> for this.</p> <h2 id="basic-data-structures"> <a href="#basic-data-structures" class="anchor-heading" aria-labelledby="basic-data-structures"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Basic data structures </h2> <p>Arrays store multiple values of the same data type and can be used to represent, for example, positions of all atoms. Arrays are indexed and can be though of as the realization of the mathematical objects that are vectors, matrices or tensors. We would like to emphasize, that choosing the right data structures is the single most important part for obtaining code that performs well.</p> <p>As a general rule, the data structure should be designed in a way that data that is processed consecutively is also stored in memory in a continuous manner. This ensures <a href="https://en.wikipedia.org/wiki/Cache_coherence">cache coherence</a>. For example, we could be tempted to create a class <code class="language-plaintext highlighter-rouge">Atom</code> that contains the positions, velocities, etc. of a single atom and than use an array (e.g. <code class="language-plaintext highlighter-rouge">std::vector&lt;Atom&gt; atoms</code>) of that class as the basic data structure. However, positions are then no longer consecutive in memory, since the <code class="language-plaintext highlighter-rouge">Atom</code> class contains velocities, possible forces, maybe charges and other properties. A function (e.g. computing forces) does not need the velocities would still load them into the cache, as the cache line size for all modern CPUs is bytes. For high-performance numerical code, it is therefore always preferable to use structures of arrays rather than arrays of structure.</p> <p>In order to store the positions, we will use an Eigen array of shape \(3\times N\) where \(N\) is the total number of atoms in our system. You can define an alias to that type with the <a href="https://en.cppreference.com/w/cpp/language/type_alias"><code class="language-plaintext highlighter-rouge">using</code></a> keyword:</p> <div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">using</span> <span class="n">Positions_t</span> <span class="o">=</span> <span class="n">Eigen</span><span class="o">::</span><span class="n">Array3Xd</span><span class="p">;</span>
</code></pre></div></div> <p>We recommend defining similar aliases for the velocities, forces etc., even if they point to the same type. This enhances readability. Place those type aliases in a separate header file, e.g. <code class="language-plaintext highlighter-rouge">types.h</code>. <a href="https://eigen.tuxfamily.org/dox/group__arraytypedefs.html"><code class="language-plaintext highlighter-rouge">Eigen::Array3Xd</code></a> is a pre-defined array type that stores <code class="language-plaintext highlighter-rouge">double</code>s (hence the suffix <code class="language-plaintext highlighter-rouge">d</code>), has \(3\) rows (this is fixed at compile time) and a dynamic number of columns (indicated by the <code class="language-plaintext highlighter-rouge">X</code>). <a href="https://eigen.tuxfamily.org/dox/group__TutorialArrayClass.html">Eigen arrays</a> are stored <a href="https://en.wikipedia.org/wiki/Row-_and_column-major_order">column major</a>, hence the \(3\) row entries are stored consecutive in memory. Note that Eigen only supports \(1\)- and \(2\)-dimensional arrays.</p> <h2 id="working-with-eigen-arrays"> <a href="#working-with-eigen-arrays" class="anchor-heading" aria-labelledby="working-with-eigen-arrays"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Working with Eigen arrays </h2> <p>We will here outline a couple of important features of <a href="https://eigen.tuxfamily.org/dox/group__TutorialArrayClass.html">Eigen arrays</a>. First, when initializing an array you need to specify the array size:</p> <div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">int</span> <span class="n">nb_atoms</span> <span class="o">=</span> <span class="mi">10</span><span class="p">;</span>
<span class="n">Positions_t</span> <span class="nf">positions</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="n">nb_atoms</span><span class="p">);</span>
</code></pre></div></div> <p>Note that the number of rows (the first argument) is fixed but we still need to provide it upon initialization. The second argument <code class="language-plaintext highlighter-rouge">nb_atoms</code> is variable. This combination of fixed-variable sizes is indicated by the <code class="language-plaintext highlighter-rouge">3X</code> suffix of the array type used here to store the positions.</p> <p>You can access values of the array using parenthesis, e.g.</p> <div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">positions</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">;</span>
</code></pre></div></div> <p>sets the \(y\)-component of the position of the second atom to \(1\). (Important: Indices start at \(0\)!) If you want to access the \(3\)-vector containing all positions of the second atom, you can use</p> <div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">auto</span> <span class="n">pos2</span><span class="p">{</span><span class="n">positions</span><span class="p">.</span><span class="n">col</span><span class="p">(</span><span class="mi">1</span><span class="p">)};</span>
</code></pre></div></div> <p>This yields <em>column</em> with index \(1\), but each column stores the three Cartesian components of the position in our case. You can for example compute the distance vector between two atoms \(i\) and \(j\) using</p> <div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">Eigen</span><span class="o">::</span><span class="n">Array3d</span> <span class="n">distance_vector</span><span class="p">{</span><span class="n">positions</span><span class="p">.</span><span class="n">col</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">-</span> <span class="n">positions</span><span class="p">.</span><span class="n">col</span><span class="p">(</span><span class="n">j</span><span class="p">)};</span>
</code></pre></div></div> <p>Note that in the above example we have use the <a href="https://en.cppreference.com/w/cpp/language/auto"><code class="language-plaintext highlighter-rouge">auto</code></a> keyword to automatically derive the type, while in the second case we have explicitly used the data type <a href="https://eigen.tuxfamily.org/dox/group__arraytypedefs.html"><code class="language-plaintext highlighter-rouge">Eigen::Array3d</code></a> for the distance vector. The curly brackets are a <a href="https://en.cppreference.com/w/cpp/language/direct_initialization">non-narrowing initialization</a>. This type of initialization avoids implicit type conversion and should be prefered over copy initialization or narrowing initialization (with round parenthesis).</p> <h2 id="integrator-for-multiple-atoms"> <a href="#integrator-for-multiple-atoms" class="anchor-heading" aria-labelledby="integrator-for-multiple-atoms"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Integrator for multiple atoms </h2> <p>You are now in a position to turn your integrator into one that accepts multiple atoms. We suggest to use the following signature for the integrators:</p> <div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#ifndef __VERLET_H
#define __VERLET_H
</span>
<span class="cp">#include &lt;Eigen/Dense&gt;
</span>
<span class="kt">void</span> <span class="nf">verlet_step1</span><span class="p">(</span><span class="n">Eigen</span><span class="o">::</span><span class="n">Array3Xd</span> <span class="o">&amp;</span><span class="n">positions</span><span class="p">,</span> <span class="n">Eigen</span><span class="o">::</span><span class="n">Array3Xd</span> <span class="o">&amp;</span><span class="n">velocities</span><span class="p">,</span>
                  <span class="k">const</span> <span class="n">Eigen</span><span class="o">::</span><span class="n">Array3Xd</span> <span class="o">&amp;</span><span class="n">forces</span><span class="p">,</span> <span class="kt">double</span> <span class="n">timestep</span><span class="p">);</span>
<span class="kt">void</span> <span class="nf">verlet_step2</span><span class="p">(</span><span class="n">Eigen</span><span class="o">::</span><span class="n">Array3Xd</span> <span class="o">&amp;</span><span class="n">velocities</span><span class="p">,</span> <span class="k">const</span> <span class="n">Eigen</span><span class="o">::</span><span class="n">Array3Xd</span> <span class="o">&amp;</span><span class="n">forces</span><span class="p">,</span> <span class="kt">double</span> <span class="n">timestep</span><span class="p">);</span>

<span class="cp">#endif  // __VERLET_H
</span></code></pre></div></div> <p>The <a href="https://en.cppreference.com/w/c/language/const"><code class="language-plaintext highlighter-rouge">const</code> qualifier</a> tells the compiler that a modification of that argument is not allowed, although it is passed as a reference. (We don’t need to modify the forces and it is good practice to protect the with this <code class="language-plaintext highlighter-rouge">const</code> qualifier to avoid accidental modification.)</p> <p>The corresponding source file <code class="language-plaintext highlighter-rouge">verlet.cpp</code> should look like this:</p> <div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#include "verlet.h"
</span>
<span class="kt">void</span> <span class="nf">verlet_step1</span><span class="p">(</span><span class="n">Eigen</span><span class="o">::</span><span class="n">Array3Xd</span> <span class="o">&amp;</span><span class="n">positions</span><span class="p">,</span> <span class="n">Eigen</span><span class="o">::</span><span class="n">Array3Xd</span> <span class="o">&amp;</span><span class="n">velocities</span><span class="p">,</span>
                  <span class="k">const</span> <span class="n">Eigen</span><span class="o">::</span><span class="n">Array3Xd</span> <span class="o">&amp;</span><span class="n">forces</span><span class="p">,</span> <span class="kt">double</span> <span class="n">timestep</span><span class="p">)</span> <span class="p">{</span>
    <span class="p">...</span> <span class="n">implement</span> <span class="n">Verlet</span> <span class="n">step1</span> <span class="n">here</span> <span class="p">...</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">verlet_step2</span><span class="p">(</span><span class="n">Eigen</span><span class="o">::</span><span class="n">Array3Xd</span> <span class="o">&amp;</span><span class="n">velocities</span><span class="p">,</span> <span class="k">const</span> <span class="n">Eigen</span><span class="o">::</span><span class="n">Array3Xd</span> <span class="o">&amp;</span><span class="n">forces</span><span class="p">,</span> <span class="kt">double</span> <span class="n">timestep</span><span class="p">)</span> <span class="p">{</span>
    <span class="p">...</span> <span class="n">implement</span> <span class="n">Verlet</span> <span class="n">step2</span> <span class="n">here</span> <span class="p">...</span>
<span class="p">}</span>
</code></pre></div></div> <p>Note that you only need to make minor modifications to your current, single-atom integrator, as the loop over atoms occurs automatically. For example, you can obtain an array containing all \(x\)-positions from <code class="language-plaintext highlighter-rouge">positions.row(0)</code>.</p> <h2 id="testing-the-integrator"> <a href="#testing-the-integrator" class="anchor-heading" aria-labelledby="testing-the-integrator"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Testing the integrator </h2> <p>Update the tests such that they test your modified integrator. These tests should probably propagate a few atoms at the same time.</p> <h2 id="task-summary"> <a href="#task-summary" class="anchor-heading" aria-labelledby="task-summary"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Task summary </h2> <p>This milestone requires the following tasks:</p> <ul> <li>Extend your Velocity-Verlet integrator to work with multiple atoms</li> <li>Update your tests to accomodate the changed interface</li> </ul> <hr> <footer> <p class="text-small text-grey-dk-100 mb-0">Copyright &copy; 2017-2020 Andreas Greiner, 2020-2021 Lars Pastewka.</a></p> <div class="d-flex mt-2"> </div> </footer> </div> </div> <div class="search-overlay"></div> </div> </body> </html>
